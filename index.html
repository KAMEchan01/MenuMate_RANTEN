<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MenuMate - 担々麺とサラダの店らんてん専用アプリ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: 
                linear-gradient(135deg, rgba(231, 199, 199, 0.3) 0%, rgba(122, 106, 106, 0.2) 50%, rgba(255,255,255,0.4) 100%),
                url('背景イメージ４品.png') center/cover no-repeat;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #d63031, #000000);
            padding: 5px 10px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 40px;
        }

        .header p {
            font-size: 15px;
            opacity: 0.9;
        }

        .content {
            padding: 30px 20px;
        }

        .question {
            margin-bottom: 30px;
        }

        .question h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .required {
            color: #d63031;
            font-size: 12px;
            font-weight: normal;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* 来店タイプ用のグリッドレイアウト */
        .button-group:first-of-type {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 10px;
        }

        /* ２回以上来店ボタンを下段に配置 */
        .button-group:first-of-type .choice-btn:last-child {
            grid-column: 1 / -1;
        }

        /* 辛さ選択用のレイアウト */
        .spicy-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 8px;
        }

        .spicy-group .choice-btn {
            font-size: 12px;
            padding: 12px 8px;
            min-width: 60px;
        }

        /* 辛口と大辛以上を下段に配置 */
        .spicy-group .choice-btn:nth-child(4) {
            grid-column: 2 / 3;
            grid-row: 2;
        }

        .spicy-group .choice-btn:last-child {
            grid-column: 3 / 4;
            grid-row: 2;
        }

        /* 気分選択用のレイアウト */
        .button-group.mood-group {
            display: flex !important;
            flex-direction: column !important;
            gap: 10px !important;
            flex-wrap: nowrap !important;
        }

        .button-group.mood-group .optional-btn {
            width: 100% !important;
            flex: none !important;
        }

        .choice-btn {
            flex: 1;
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .choice-btn.selected {
            background: #d63031;
            color: white;
            border-color: #d63031;
        }


        .allergy-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .allergy-btn {
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .allergy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .allergy-btn.selected {
            background: #fdcb6e;
            color: white;
            border-color: #fdcb6e;
        }

        .no-allergy-btn {
            width: 100%;
            padding: 12px;
            border: 2px solid #00b894;
            background: white;
            color: #00b894;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .no-allergy-btn:hover {
            background: #00b894;
            color: white;
        }

        .no-allergy-btn.selected {
            background: #00b894;
            color: white;
        }

        .optional-btn {
            width: 100%;
            padding: 15px;
            border: 2px dashed #e0e0e0;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .optional-btn:hover {
            background: #fff3cd;
            border-color: #feca57;
        }

        .optional-btn.selected {
            background: #feca57;
            color: white;
            border-color: #feca57;
        }

        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #d63031, #000000);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            display: none;
        }

        .result-card {
            background: linear-gradient(135deg, #f82258, #f83b3b);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            color: white;
        }

        .result-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .result-header h3 {
            color: white;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }

        .menu-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 18px;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid rgba(255,255,255,0.5);
        }

        .menu-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .menu-price {
            font-weight: bold;
            color: white;
        }

        .signature-badge {
            background: #feca57;
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
        }

        .comment {
            background: #fff3cd;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #feca57;
        }

        .comment p {
            color: #333;
            font-size: 16px;
            line-height: 1.5;
        }

        .allergy-warning {
            background: #ffebe6;
            border: 2px solid #ff7675;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }

        .allergy-warning h4 {
            color: #d63031;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .allergy-warning p {
            color: #333;
            font-size: 13px;
            line-height: 1.4;
        }

        .spicy-adjust {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .spicy-adjust h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .spicy-adjust-buttons {
            display: flex;
            gap: 10px;
        }

        .spicy-adjust-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .spicy-adjust-btn:hover {
            background: #ff7675;
            color: white;
            border-color: #ff7675;
        }

        .final-btn {
            width: 100%;
            padding: 18px;
            background: #00b894;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .final-btn:hover {
            background: #00a085;
            transform: translateY(-2px);
        }

        .back-btn {
            width: 100%;
            padding: 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .back-btn:hover {
            background: #545b62;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .choice-btn {
                min-width: 100%;
            }

            .allergy-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🍜 MenuMate</h1>
            <img src="らんてんロゴカット.png" alt="らんてん店名ロゴ" style="height: 150px; margin: 5px 0; object-fit: contain;">
        </div>

        <div id="selection-screen" class="content">
            <div class="question">
                <h3>👥 ご来店タイプをお選びください <span class="required">※必須</span></h3>
                <div class="button-group">
                    <button class="choice-btn" data-visitor-type="first-male">初めての方<br><small>（男性）</small></button>
                    <button class="choice-btn" data-visitor-type="first-female">初めての方<br><small>（女性）</small></button>
                    <button class="choice-btn" data-visitor-type="with-kids">お子様連れ<br><small>の方</small></button>
                    <button class="choice-btn" data-visitor-type="returning">２回以上来店<br><small></small></button>
                </div>
            </div>

            <div class="question">
                <h3>🌶️ 辛さの好みをお選びください <span class="required">※必須</span></h3>
                <div class="button-group spicy-group">
                    <button class="choice-btn" data-spicy="0">辛さなし<br><small>1</small></button>
                    <button class="choice-btn" data-spicy="2">ひかえめ<br><small>2</small></button>
                    <button class="choice-btn" data-spicy="3">ふつう<br><small>3</small></button>
                    <button class="choice-btn" data-spicy="4">辛口<br><small>4</small></button>
                    <button class="choice-btn" data-spicy="5">大辛以上<br><small>5</small></button>
                </div>
            </div>

            <div class="question">
                <h3>⚠️ アレルギーがあるものを選んでください <span class="required">※必須</span></h3>
                <div class="allergy-grid">
                    <button class="allergy-btn" data-allergy="小麦">小麦</button>
                    <button class="allergy-btn" data-allergy="大豆">大豆</button>
                    <button class="allergy-btn" data-allergy="卵">卵</button>
                    <button class="allergy-btn" data-allergy="乳製品">乳製品</button>
                    <button class="allergy-btn" data-allergy="ごま">ごま</button>
                    <button class="allergy-btn" data-allergy="えび">えび</button>
                    <button class="allergy-btn" data-allergy="鶏肉">鶏肉</button>
                    <button class="allergy-btn" data-allergy="豚肉">豚肉</button>
                </div>
                <button class="no-allergy-btn" id="no-allergy-btn">アレルギーなし</button>
            </div>

            <div class="question">
                <h3>✨ 今日の気分は？</h3>
                <div class="button-group mood-group">
                    <button class="optional-btn" data-mood="hearty">がっつり系<br><small>満腹重視</small></button>
                    <button class="optional-btn" data-mood="healthy">あっさり系<br><small>ヘルシー重視</small></button>
                </div>
            </div>

            <button id="submit-btn" class="submit-btn" disabled>🎯 おすすめを教えて！</button>
        </div>

        <div id="result-screen" class="content result">
            <div class="result-card">
                <div class="result-header">
                    <h3>💡 らんてんMenuMateからの提案</h3>
                </div>
                <div id="menu-items"></div>
            </div>

            <div class="comment">
                <p id="comment-text"></p>
            </div>

            <div id="allergy-warning" class="allergy-warning" style="display: none;">
                <h4>⚠️ アレルギー情報</h4>
                <p id="allergy-warning-text"></p>
            </div>

            <div class="spicy-adjust">
                <h4>🌶️ 辛さ調整</h4>
                <div class="spicy-adjust-buttons">
                    <button class="spicy-adjust-btn" onclick="adjustSpiciness(-1)">より弱く</button>
                    <button class="spicy-adjust-btn" onclick="adjustSpiciness(0)">このまま</button>
                    <button class="spicy-adjust-btn" onclick="adjustSpiciness(1)">より辛く</button>
                </div>
            </div>

            <button class="final-btn" onclick="finalDecision()">✅ これで注文します！</button>
            <button class="back-btn" onclick="goBack()">← 最初から選び直す</button>
        </div>

        <div id="final-screen" class="content result">
            <div class="result-header" style="text-align: center; margin-bottom: 30px;">
                <h3>🎉 素敵なお食事を<br>お楽しみください 🎉</h3>
            </div>
            
            <div class="result-card">
                <div class="result-header">
                    <h3>📋 ご注文内容</h3>
                </div>
                <div id="final-menu-items"></div>
            </div>

            <div class="comment">
                <p id="final-comment-text"></p>
            </div>
            
            <button class="back-btn" onclick="restart()">← 新しく選ぶ</button>
        </div>
    </div>

    <script type="module">
        import menuDatabase from './src/menuDatabase.js';

        // 選択状態
        let selections = {
            visitorType: null,
            spiciness: null,
            allergies: [],
            mood: null
        };

        let currentSuggestion = null;

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            // 来店タイプ選択ボタン
            document.querySelectorAll('[data-visitor-type]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-visitor-type]').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selections.visitorType = this.dataset.visitorType;
                    checkSubmitButton();
                });
            });

            // 辛さ選択ボタン
            document.querySelectorAll('[data-spicy]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-spicy]').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selections.spiciness = parseInt(this.dataset.spicy);
                    checkSubmitButton();
                });
            });

            // アレルギー選択ボタン
            document.querySelectorAll('[data-allergy]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const allergy = this.dataset.allergy;
                    
                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                        selections.allergies = selections.allergies.filter(a => a !== allergy);
                    } else {
                        this.classList.add('selected');
                        selections.allergies.push(allergy);
                        // アレルギーありを選択した場合、アレルギーなしボタンを無効化
                        document.getElementById('no-allergy-btn').classList.remove('selected');
                    }
                    checkSubmitButton();
                });
            });

            // アレルギーなしボタン
            document.getElementById('no-allergy-btn').addEventListener('click', function() {
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                } else {
                    this.classList.add('selected');
                    // 他のアレルギーボタンをすべて無効化
                    document.querySelectorAll('[data-allergy]').forEach(btn => btn.classList.remove('selected'));
                    selections.allergies = [];
                }
                checkSubmitButton();
            });

            // 気分ボタン（任意）
            document.querySelectorAll('[data-mood]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-mood]').forEach(b => b.classList.remove('selected'));
                    
                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                        selections.mood = null;
                    } else {
                        this.classList.add('selected');
                        selections.mood = this.dataset.mood;
                    }
                });
            });

            // 提案ボタン
            document.getElementById('submit-btn').addEventListener('click', function() {
                generateSuggestion();
            });
        }

        function checkSubmitButton() {
            const submitBtn = document.getElementById('submit-btn');
            const allergySelected = selections.allergies.length > 0 || document.getElementById('no-allergy-btn').classList.contains('selected');
            
            if (selections.visitorType && selections.spiciness !== null && allergySelected) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        function generateSuggestion() {
            const suggestion = createSuggestion(selections);
            currentSuggestion = suggestion;
            displaySuggestion(suggestion);
            showResultScreen();
        }

        function createSuggestion(selections) {
            const visitorType = selections.visitorType;
            const spiciness = selections.spiciness;
            const allergies = selections.allergies;
            const mood = selections.mood;
            
            // アレルギー対応メニューを取得
            let availableMenus = menuDatabase.getMenusWithoutAllergens(allergies);
            
            // 辛さレベルに適したメニューを優先
            let suitableMenus = availableMenus.filter(menu => {
                if (menu.spicyLevel === 0) return true; // 辛くないメニューは常に適用
                return Math.abs(menu.spicyLevel - spiciness) <= 1; // ±1レベルまで許容
            });
            
            // 適切なメニューがない場合は全メニューから選択
            if (suitableMenus.length === 0) {
                suitableMenus = availableMenus;
            }
            
            // 来店タイプ別の推薦処理
            if (visitorType === 'first-male') {
                // 初めての方（男性）: 定番メニューで満足感重視、担々麺を中心
                return createFirstMaleSuggestion(spiciness, allergies, mood);
            } else if (visitorType === 'first-female') {
                // 初めての方（女性）: ヘルシーでバランス重視、サラダセットなど
                return createFirstFemaleSuggestion(spiciness, allergies, mood);
            } else if (visitorType === 'with-kids') {
                // お子様連れの方: 辛さ控えめ、取り分けしやすいメニュー
                return createWithKidsSuggestion(spiciness, allergies, mood);
            } else if (visitorType === 'returning') {
                // ２回以上来店: リピーター向け、名物メニューや冒険的な組み合わせ
                return createReturningSuggestion(spiciness, allergies, mood);
            }
            
            // 従来の予算別処理（フォールバック）
            if (selections.budget === 'luxury') {
                // 担々麺または湯麺から1品選択
                const noodleMenus = [...menuDatabase.tantanmen, ...menuDatabase.yunmen].filter(menu => 
                    !allergies.some(allergen => menu.allergens.includes(allergen))
                );
                
                // サラダから1品選択
                const saladMenus = menuDatabase.salads.filter(salad => 
                    !allergies.some(allergen => salad.allergens.includes(allergen))
                );
                
                // サイドメニューから1品選択
                const sideMenus = menuDatabase.sides.filter(side => 
                    !allergies.some(allergen => side.allergens.includes(allergen))
                );
                
                if (noodleMenus.length > 0 && saladMenus.length > 0 && sideMenus.length > 0) {
                    // 辛さレベルに適した麺類を優先選択
                    let suitableNoodles = noodleMenus.filter(menu => {
                        if (menu.spicyLevel === 0) return true;
                        return Math.abs(menu.spicyLevel - spiciness) <= 1;
                    });
                    if (suitableNoodles.length === 0) suitableNoodles = noodleMenus;
                    
                    const selectedNoodle = suitableNoodles[Math.floor(Math.random() * suitableNoodles.length)];
                    const selectedSalad = saladMenus[Math.floor(Math.random() * saladMenus.length)];
                    const selectedSide = sideMenus[Math.floor(Math.random() * sideMenus.length)];
                    
                    const totalPrice = selectedNoodle.price + selectedSalad.price + selectedSide.price;
                    
                    // 辛さ調整
                    const adjustedNoodle = {
                        ...selectedNoodle,
                        adjustedSpiciness: spiciness,
                        originalSpiciness: selectedNoodle.spicyLevel
                    };
                    
                    return {
                        menu: adjustedNoodle,
                        extraMenus: [selectedSalad, selectedSide],
                        totalPrice: totalPrice,
                        comment: generateLuxuryComment(adjustedNoodle, selectedSalad, selectedSide, selections),
                        allergyWarning: generateAllergyWarning(adjustedNoodle, allergies)
                    };
                }
            }
            
            // 普通予算の場合の処理（担々麺または湯麺から1品）
            if (selections.budget === 'normal') {
                // 担々麺または湯麺から選択
                const noodleMenus = [...menuDatabase.tantanmen, ...menuDatabase.yunmen].filter(menu => 
                    !allergies.some(allergen => menu.allergens.includes(allergen)) &&
                    menu.price <= budget.max
                );
                
                if (noodleMenus.length > 0) {
                    // 辛さレベルに適したメニューを優先選択
                    let suitableNoodles = noodleMenus.filter(menu => {
                        if (menu.spicyLevel === 0) return true; // 辛くないメニューは常に適用
                        return Math.abs(menu.spicyLevel - spiciness) <= 1; // ±1レベルまで許容
                    });
                    if (suitableNoodles.length === 0) suitableNoodles = noodleMenus;
                    
                    const selectedNoodle = suitableNoodles[Math.floor(Math.random() * suitableNoodles.length)];
                    
                    // 辛さ調整
                    const adjustedMenu = {
                        ...selectedNoodle,
                        adjustedSpiciness: spiciness,
                        originalSpiciness: selectedNoodle.spicyLevel
                    };
                    
                    return {
                        menu: adjustedMenu,
                        comment: generateComment(adjustedMenu, selections),
                        allergyWarning: generateAllergyWarning(adjustedMenu, allergies)
                    };
                }
            }
            
            // 控えめ予算の場合の処理（サイドメニューまたはサラダから選択）
            if (selections.budget === 'light') {
                // サラダまたはサイドメニューから600円以下のメニューを選択
                const lightMenus = [...menuDatabase.salads, ...menuDatabase.sides].filter(menu => 
                    !allergies.some(allergen => menu.allergens.includes(allergen)) &&
                    menu.price <= 600
                );
                
                if (lightMenus.length > 0) {
                    // 気分に応じた選択
                    let filteredMenus;
                    if (mood === 'healthy') {
                        // あっさり系：サラダを優先
                        filteredMenus = lightMenus.filter(menu => menu.category === 'salad');
                        if (filteredMenus.length === 0) filteredMenus = lightMenus;
                    } else if (mood === 'hearty') {
                        // がっつり系：サイドメニューを優先
                        filteredMenus = lightMenus.filter(menu => menu.category === 'side');
                        if (filteredMenus.length === 0) filteredMenus = lightMenus;
                    } else {
                        filteredMenus = lightMenus;
                    }
                    
                    const selectedMenu = filteredMenus[Math.floor(Math.random() * filteredMenus.length)];
                    
                    return {
                        menu: selectedMenu,
                        comment: generateLightBudgetComment(selectedMenu, selections),
                        allergyWarning: generateAllergyWarning(selectedMenu, allergies)
                    };
                }
            }
            
            // その他の予算での気分に応じたメニュー選択
            let selectedMenu;
            if (mood === 'hearty') {
                // がっつり系：チャーシュー担々麺、セットメニューを優先
                const heartyMenus = availableMenus.filter(menu => 
                    menu.name.includes('チャーシュー') || 
                    menu.name.includes('セット') || 
                    menu.category === 'tantanmen'
                );
                selectedMenu = heartyMenus.length > 0 ? 
                    heartyMenus[Math.floor(Math.random() * heartyMenus.length)] :
                    availableMenus[Math.floor(Math.random() * availableMenus.length)];
            } else if (mood === 'healthy') {
                // あっさり系：サラダ、湯麺を優先
                const healthyMenus = availableMenus.filter(menu => 
                    menu.category === 'salad' || 
                    menu.category === 'yunmen' ||
                    menu.name.includes('トマト')
                );
                selectedMenu = healthyMenus.length > 0 ? 
                    healthyMenus[Math.floor(Math.random() * healthyMenus.length)] :
                    availableMenus[Math.floor(Math.random() * availableMenus.length)];
            } else {
                // 通常選択
                selectedMenu = availableMenus[Math.floor(Math.random() * availableMenus.length)];
            }
            
            // 辛さ調整
            const adjustedMenu = {
                ...selectedMenu,
                adjustedSpiciness: spiciness,
                originalSpiciness: selectedMenu.spicyLevel
            };
            
            return {
                menu: adjustedMenu,
                comment: generateComment(adjustedMenu, selections),
                allergyWarning: generateAllergyWarning(adjustedMenu, allergies)
            };
        }

        function getBudgetRange(budget) {
            switch(budget) {
                case 'luxury': return {max: 1500, min: 1200};
                case 'normal': return {max: 1200, min: 800};
                case 'light': return {max: 800, min: 600};
                default: return {max: 1000, min: 700};
            }
        }

        function generateVisitorTypeComment(visitorType, menu, selections) {
            const comments = [];
            
            // 来店タイプ別コメント
            if (visitorType === 'first-male') {
                comments.push('らんてんの定番をしっかり味わえる満足メニューです');
                comments.push('初回来店におすすめの人気メニューです');
                comments.push('ボリューム満点で満足いただけると思います');
            } else if (visitorType === 'first-female') {
                comments.push('ヘルシーでバランスの良い、らんてんおすすめの組み合わせです');
                comments.push('女性に人気のヘルシーセットです');
                comments.push('美味しくて体に優しいメニューをご提案しました');
            } else if (visitorType === 'with-kids') {
                comments.push('お子様と一緒にお楽しみいただける、優しい味のメニューです');
                comments.push('お子様でも安心してお召し上がりいただけます');
                comments.push('取り分けしやすいメニューをご提案しました');
            } else if (visitorType === 'returning') {
                comments.push('リピーターの方におすすめ！いつもと違う組み合わせをお試しください');
                comments.push('常連様向けの特別なメニューをご提案いたします');
                comments.push('新しい味の発見をお楽しみください');
                if (menu.isSignature) {
                    comments.push('らんてん自慢の名物メニューです！');
                }
            }
            
            // 辛さ別コメント
            if (selections.spiciness === 0) {
                comments.push('辛味を使わない、お子様でも安心のメニューです');
            } else if (selections.spiciness === 2) {
                comments.push('辛いのが苦手な方も安心、まろやかな担々麺です');
            } else if (selections.spiciness === 3) {
                comments.push('らんてんの基本の辛さ、胡麻の風味が際立ちます');
            } else if (selections.spiciness === 4) {
                comments.push('しっかりとした辛さで、満足感のある一杯です');
            } else if (selections.spiciness === 5) {
                comments.push('辛党の方必見！本格四川の刺激をご堪能ください');
            }
            
            // アレルギー対応コメント
            if (selections.allergies.length > 0) {
                comments.push('アレルギーに配慮した安心メニューをご提案しました');
            }
            
            // 気分別コメント
            if (selections.mood === 'hearty') {
                comments.push('がっつり系でお腹いっぱいになります');
            } else if (selections.mood === 'healthy') {
                comments.push('あっさりヘルシーで午後もすっきり');
            }
            
            return comments[Math.floor(Math.random() * comments.length)];
        }

        function generateComment(menu, selections) {
            const comments = [];
            
            // 名物メニューの場合
            if (menu.isSignature) {
                comments.push('らんてんの名物メニューです！ミシュランガイド掲載シェフの技をご堪能ください。');
                return comments[0];
            }
            
            // 予算別コメント
            if (selections.budget === 'luxury') {
                comments.push('今日は特別な日！らんてんの一番贅沢なメニューはいかが？');
            } else if (selections.budget === 'normal') {
                comments.push('らんてんの定番、担々麺の美味しさをしっかり味わえます');
            } else {
                comments.push('ヘルシーに決めるなら、新鮮サラダがおすすめ！');
            }
            
            // 辛さ別コメント
            if (selections.spiciness <= 2) {
                comments.push('辛いのが苦手な方も安心、まろやかな担々麺です');
            } else if (selections.spiciness === 3) {
                comments.push('らんてんの基本の辛さ、胡麻の風味が際立ちます');
            } else {
                comments.push('辛党の方必見！本格四川の刺激をご堪能ください');
            }
            
            // アレルギー対応コメント
            if (selections.allergies.length > 0) {
                comments.push('アレルギーに配慮した安心メニューをご提案しました');
            } else {
                comments.push('アレルギーの心配なく、お好きなメニューをどうぞ！');
            }
            
            // 気分別コメント
            if (selections.mood === 'hearty') {
                comments.push('チャーシューたっぷり！満腹間違いなしの組み合わせ');
            } else if (selections.mood === 'healthy') {
                comments.push('野菜たっぷりでヘルシー、体に優しいメニューです');
            }
            
            return comments[Math.floor(Math.random() * comments.length)];
        }

        function generateLuxuryComment(noodle, salad, side, selections) {
            const comments = [
                '贅沢な3品セットで特別なお食事をお楽しみください！',
                'らんてん自慢のコース料理スタイルでご提供いたします',
                '麺・サラダ・サイドの絶妙なバランスが自慢のセットです',
                '今日は特別！らんてんの美味しさを存分に味わえるセットメニュー'
            ];
            
            return comments[Math.floor(Math.random() * comments.length)];
        }

        function generateLightBudgetComment(menu, selections) {
            const comments = [];
            
            // メニュー種類別コメント
            if (menu.category === 'salad') {
                comments.push('ヘルシーで新鮮なサラダをお楽しみください！');
                comments.push('野菜たっぷりで体に優しいメニューです');
                comments.push('リーズナブルでも満足感のあるサラダです');
            } else if (menu.category === 'side') {
                comments.push('お手軽価格で美味しいサイドメニューです！');
                comments.push('小腹が空いた時にぴったりの一品');
                comments.push('控えめ予算でも満足いただけるメニューです');
            }
            
            // 気分別コメント
            if (selections.mood === 'healthy') {
                comments.push('あっさりヘルシーで午後もすっきり');
            } else if (selections.mood === 'hearty') {
                comments.push('小さくても満足感のある一品です');
            }
            
            // アレルギー対応コメント
            if (selections.allergies.length > 0) {
                comments.push('アレルギーに配慮した安心メニューです');
            }
            
            return comments[Math.floor(Math.random() * comments.length)];
        }

        function generateAllergyWarning(menu, userAllergies) {
            if (userAllergies.length === 0) return null;
            
            const menuAllergens = menu.allergens || [];
            const commonAllergens = menuAllergens.filter(allergen => 
                !userAllergies.includes(allergen)
            );
            
            if (menuAllergens.length > 0) {
                return `このメニューに含まれるアレルゲン: ${menuAllergens.join('、')}`;
            }
            
            return null;
        }

        // 来店タイプ別推薦関数
        function createFirstMaleSuggestion(spiciness, allergies, mood) {
            // 初めての方（男性）: 担々麺を必ず提案
            const tantanmenMenus = menuDatabase.tantanmen.filter(menu => 
                !allergies.some(allergen => menu.allergens.includes(allergen))
            );
            
            if (tantanmenMenus.length === 0) {
                return createGenericSuggestion(spiciness, allergies, mood);
            }
            
            // 辛さレベルに適した担々麺を選択
            let suitableMenus = tantanmenMenus.filter(menu => 
                Math.abs(menu.spicyLevel - spiciness) <= 1
            );
            if (suitableMenus.length === 0) suitableMenus = tantanmenMenus;
            
            const selectedMenu = suitableMenus[Math.floor(Math.random() * suitableMenus.length)];
            
            // がっつり系の場合は3品セットを提案
            if (mood === 'hearty') {
                return createHeartySet(selectedMenu, spiciness, allergies, 'first-male');
            }
            
            return {
                menu: { ...selectedMenu, adjustedSpiciness: spiciness, originalSpiciness: selectedMenu.spicyLevel },
                comment: generateVisitorTypeComment('first-male', selectedMenu, { spiciness, allergies, mood }),
                allergyWarning: generateAllergyWarning(selectedMenu, allergies)
            };
        }

        function createFirstFemaleSuggestion(spiciness, allergies, mood) {
            // 初めての方（女性）: 担々麺を必ず提案
            const tantanmenMenus = menuDatabase.tantanmen.filter(menu => 
                !allergies.some(allergen => menu.allergens.includes(allergen))
            );
            
            if (tantanmenMenus.length === 0) {
                return createGenericSuggestion(spiciness, allergies, mood);
            }
            
            // 辛さレベルに適した担々麺を選択
            let suitableMenus = tantanmenMenus.filter(menu => 
                Math.abs(menu.spicyLevel - spiciness) <= 1
            );
            if (suitableMenus.length === 0) suitableMenus = tantanmenMenus;
            
            const selectedMenu = suitableMenus[Math.floor(Math.random() * suitableMenus.length)];
            
            // がっつり系の場合は3品セットを提案
            if (mood === 'hearty') {
                return createHeartySet(selectedMenu, spiciness, allergies, 'first-female');
            }
            
            // ヘルシー志向なので、サラダを追加
            const saladMenus = menuDatabase.salads.filter(salad => 
                !allergies.some(allergen => salad.allergens.includes(allergen))
            );
            
            if (saladMenus.length > 0) {
                const selectedSalad = saladMenus[Math.floor(Math.random() * saladMenus.length)];
                return {
                    menu: { ...selectedMenu, adjustedSpiciness: spiciness, originalSpiciness: selectedMenu.spicyLevel },
                    extraMenus: [selectedSalad],
                    totalPrice: selectedMenu.price + selectedSalad.price,
                    comment: generateVisitorTypeComment('first-female', selectedMenu, { spiciness, allergies, mood }),
                    allergyWarning: generateAllergyWarning(selectedMenu, allergies)
                };
            }
            
            return {
                menu: { ...selectedMenu, adjustedSpiciness: spiciness, originalSpiciness: selectedMenu.spicyLevel },
                comment: generateVisitorTypeComment('first-female', selectedMenu, { spiciness, allergies, mood }),
                allergyWarning: generateAllergyWarning(selectedMenu, allergies)
            };
        }

        function createWithKidsSuggestion(spiciness, allergies, mood) {
            // お子様連れの方: 辛さなしメニューを必ず提案
            // 辛さレベル0のメニューまたは湯麺を優先
            const noSpiceMenus = [...menuDatabase.tanmen, ...menuDatabase.salads, ...menuDatabase.sides]
                .filter(menu => 
                    menu.spicyLevel === 0 &&
                    !allergies.some(allergen => menu.allergens.includes(allergen))
                );
            
            // 辛さレベル0のメニューがない場合は、辛さレベル1の湯麺を選択
            if (noSpiceMenus.length === 0) {
                const mildTanmenMenus = menuDatabase.tanmen.filter(menu => 
                    menu.spicyLevel <= 1 &&
                    !allergies.some(allergen => menu.allergens.includes(allergen))
                );
                
                if (mildTanmenMenus.length > 0) {
                    const selectedMenu = mildTanmenMenus[Math.floor(Math.random() * mildTanmenMenus.length)];
                    
                    // がっつり系の場合は3品セットを提案
                    if (mood === 'hearty') {
                        return createHeartySet(selectedMenu, 0, allergies, 'with-kids'); // 辛さを0に固定
                    }
                    
                    return {
                        menu: { ...selectedMenu, adjustedSpiciness: 0, originalSpiciness: selectedMenu.spicyLevel },
                        comment: generateVisitorTypeComment('with-kids', selectedMenu, { spiciness: 0, allergies, mood }),
                        allergyWarning: generateAllergyWarning(selectedMenu, allergies)
                    };
                }
                
                return createGenericSuggestion(0, allergies, mood); // 辛さを0に固定
            }
            
            const selectedMenu = noSpiceMenus[Math.floor(Math.random() * noSpiceMenus.length)];
            
            // がっつり系の場合は3品セットを提案
            if (mood === 'hearty') {
                return createHeartySet(selectedMenu, 0, allergies, 'with-kids'); // 辛さを0に固定
            }
            
            return {
                menu: { ...selectedMenu, adjustedSpiciness: 0, originalSpiciness: selectedMenu.spicyLevel },
                comment: generateVisitorTypeComment('with-kids', selectedMenu, { spiciness: 0, allergies, mood }),
                allergyWarning: generateAllergyWarning(selectedMenu, allergies)
            };
        }

        function createReturningSuggestion(spiciness, allergies, mood) {
            // ２回以上来店: 担々麺以外のメニューを提案
            
            // 湯麺、サラダ、サイドメニューから選択（担々麺を除外）
            const nonTantanmenMenus = [...menuDatabase.tanmen, ...menuDatabase.salads, ...menuDatabase.sides]
                .filter(menu => 
                    !allergies.some(allergen => menu.allergens.includes(allergen)) &&
                    (spiciness === 0 ? menu.spicyLevel <= 1 : Math.abs(menu.spicyLevel - spiciness) <= 2)
                );
            
            if (nonTantanmenMenus.length === 0) {
                return createGenericSuggestion(spiciness, allergies, mood);
            }
            
            // 湯麺を優先的に選択
            let priorityMenus = nonTantanmenMenus.filter(menu => menu.category === 'tanmen');
            if (priorityMenus.length === 0) priorityMenus = nonTantanmenMenus;
            
            const selectedMenu = priorityMenus[Math.floor(Math.random() * priorityMenus.length)];
            
            // がっつり系の場合は3品セットを提案
            if (mood === 'hearty') {
                return createHeartySet(selectedMenu, spiciness, allergies, 'returning');
            }
            
            // 冒険的な組み合わせとして、サラダやサイドメニューを追加
            const saladMenus = menuDatabase.salads.filter(salad => 
                !allergies.some(allergen => salad.allergens.includes(allergen))
            );
            
            const sideMenus = menuDatabase.sides.filter(side => 
                !allergies.some(allergen => side.allergens.includes(allergen))
            );
            
            // 50%の確率でサラダまたはサイドメニューを追加
            if (Math.random() < 0.5 && (saladMenus.length > 0 || sideMenus.length > 0)) {
                const extraMenu = Math.random() < 0.5 && saladMenus.length > 0 ? 
                    saladMenus[Math.floor(Math.random() * saladMenus.length)] :
                    sideMenus[Math.floor(Math.random() * sideMenus.length)];
                
                return {
                    menu: { ...selectedMenu, adjustedSpiciness: spiciness, originalSpiciness: selectedMenu.spicyLevel },
                    extraMenus: [extraMenu],
                    totalPrice: selectedMenu.price + extraMenu.price,
                    comment: generateVisitorTypeComment('returning', selectedMenu, { spiciness, allergies, mood }),
                    allergyWarning: generateAllergyWarning(selectedMenu, allergies)
                };
            }
            
            return {
                menu: { ...selectedMenu, adjustedSpiciness: spiciness, originalSpiciness: selectedMenu.spicyLevel },
                comment: generateVisitorTypeComment('returning', selectedMenu, { spiciness, allergies, mood }),
                allergyWarning: generateAllergyWarning(selectedMenu, allergies)
            };
        }

        function createHeartySet(baseMenu, spiciness, allergies, visitorType) {
            // がっつり系選択時の3品セット提案機能
            const saladMenus = menuDatabase.salads.filter(salad => 
                !allergies.some(allergen => salad.allergens.includes(allergen))
            );
            
            const sideMenus = menuDatabase.sides.filter(side => 
                !allergies.some(allergen => side.allergens.includes(allergen))
            );
            
            const extraMenus = [];
            let totalPrice = baseMenu.price;
            
            // サラダを追加
            if (saladMenus.length > 0) {
                const selectedSalad = saladMenus[Math.floor(Math.random() * saladMenus.length)];
                extraMenus.push(selectedSalad);
                totalPrice += selectedSalad.price;
            }
            
            // サイドメニューを追加
            if (sideMenus.length > 0) {
                const selectedSide = sideMenus[Math.floor(Math.random() * sideMenus.length)];
                extraMenus.push(selectedSide);
                totalPrice += selectedSide.price;
            }
            
            return {
                menu: { ...baseMenu, adjustedSpiciness: spiciness, originalSpiciness: baseMenu.spicyLevel },
                extraMenus: extraMenus,
                totalPrice: totalPrice,
                comment: generateVisitorTypeComment(visitorType, baseMenu, { spiciness, allergies, mood: 'hearty' }),
                allergyWarning: generateAllergyWarning(baseMenu, allergies)
            };
        }

        function createGenericSuggestion(spiciness, allergies, mood) {
            // 汎用的な推薦（フォールバック）
            const allMenus = menuDatabase.getAllMenus().filter(menu => 
                !allergies.some(allergen => menu.allergens.includes(allergen))
            );
            
            if (allMenus.length === 0) {
                return {
                    menu: null,
                    comment: 'アレルギー対応メニューが見つかりませんでした。店舗スタッフにご相談ください。',
                    allergyWarning: null
                };
            }
            
            const selectedMenu = allMenus[Math.floor(Math.random() * allMenus.length)];
            return {
                menu: { ...selectedMenu, adjustedSpiciness: spiciness, originalSpiciness: selectedMenu.spicyLevel },
                comment: generateComment(selectedMenu, { spiciness, allergies, mood }),
                allergyWarning: generateAllergyWarning(selectedMenu, allergies)
            };
        }

        function createFallbackSuggestion(budget, allergies) {
            // アレルギー対応の安全なメニューを提案
            const safeMenus = menuDatabase.salads.filter(menu => 
                menu.allergens.length === 0 && menu.price <= budget.max
            );
            
            if (safeMenus.length > 0) {
                return {
                    menu: safeMenus[0],
                    comment: 'アレルギーに配慮した安全なメニューをお選びしました。',
                    allergyWarning: null
                };
            }
            
            return {
                menu: {
                    name: 'スタッフにご相談ください',
                    price: 0,
                    description: 'お客様のアレルギー情報を考慮した特別メニューをご提案いたします。'
                },
                comment: 'お客様のご要望に合わせてスタッフが個別にご提案いたします。',
                allergyWarning: null
            };
        }

        function displaySuggestion(suggestion) {
            const menuItems = document.getElementById('menu-items');
            const commentText = document.getElementById('comment-text');
            const allergyWarning = document.getElementById('allergy-warning');
            const allergyWarningText = document.getElementById('allergy-warning-text');
            
            menuItems.innerHTML = '';
            
            const menu = suggestion.menu;
            let totalPrice = menu.price;
            
            // メインメニューを表示
            const menuItem = document.createElement('div');
            menuItem.className = 'menu-item';
            
            let spicyIndicator = '';
            if (menu.adjustedSpiciness && menu.adjustedSpiciness > 0) {
                const spicyLevel = menuDatabase.spicyLevels[menu.adjustedSpiciness];
                spicyIndicator = ` (辛さ${menu.adjustedSpiciness}: ${spicyLevel.name})`;
            }
            
            let signatureBadge = '';
            if (menu.isSignature) {
                signatureBadge = '<span class="signature-badge">名物</span>';
            }
            
            menuItem.innerHTML = `
                <div class="menu-name">🍜 ${menu.name}${spicyIndicator}${signatureBadge}</div>
                <div class="menu-price">${menu.price}円</div>
            `;
            menuItems.appendChild(menuItem);
            
            // エクストラメニュー（サラダ）がある場合
            if (suggestion.extraMenu) {
                const extraItem = document.createElement('div');
                extraItem.className = 'menu-item';
                extraItem.innerHTML = `
                    <div class="menu-name">🥗 ${suggestion.extraMenu.name}</div>
                    <div class="menu-price">${suggestion.extraMenu.price}円</div>
                `;
                menuItems.appendChild(extraItem);
                totalPrice += suggestion.extraMenu.price;
            }
            
            // 贅沢セットの複数エクストラメニューがある場合
            if (suggestion.extraMenus) {
                suggestion.extraMenus.forEach((extraMenu, index) => {
                    const extraItem = document.createElement('div');
                    extraItem.className = 'menu-item';
                    const icon = index === 0 ? '🥗' : '🍽️';
                    extraItem.innerHTML = `
                        <div class="menu-name">${icon} ${extraMenu.name}</div>
                        <div class="menu-price">${extraMenu.price}円</div>
                    `;
                    menuItems.appendChild(extraItem);
                    totalPrice += extraMenu.price;
                });
            }
            
            // 合計金額を表示
            const totalItem = document.createElement('div');
            totalItem.className = 'menu-item';
            const finalPrice = suggestion.totalPrice || totalPrice;
            totalItem.innerHTML = `
                <div class="menu-name">💰 合計金額</div>
                <div class="menu-price">${finalPrice}円</div>
            `;
            menuItems.appendChild(totalItem);
            
            commentText.textContent = suggestion.comment;
            
            if (suggestion.allergyWarning) {
                allergyWarningText.textContent = suggestion.allergyWarning;
                allergyWarning.style.display = 'block';
            } else {
                allergyWarning.style.display = 'none';
            }
        }

        function adjustSpiciness(adjustment) {
            if (!currentSuggestion || !currentSuggestion.menu) return;
            
            const currentLevel = currentSuggestion.menu.adjustedSpiciness || currentSuggestion.menu.spicyLevel;
            const newLevel = Math.max(1, Math.min(5, currentLevel + adjustment));
            
            if (newLevel !== currentLevel) {
                currentSuggestion.menu.adjustedSpiciness = newLevel;
                
                // 辛さレベルに応じたコメント更新
                const spicyLevel = menuDatabase.spicyLevels[newLevel];
                if (adjustment > 0) {
                    currentSuggestion.comment = `辛さを${newLevel}に調整しました。${spicyLevel.description}`;
                } else if (adjustment < 0) {
                    currentSuggestion.comment = `辛さを${newLevel}に調整しました。${spicyLevel.description}`;
                } else {
                    currentSuggestion.comment = `標準の辛さ（レベル${newLevel}）です。${spicyLevel.description}`;
                }
                
                displaySuggestion(currentSuggestion);
            }
        }

        function displayFinalDecision() {
            if (!currentSuggestion) return;
            
            const finalMenuItems = document.getElementById('final-menu-items');
            const finalCommentText = document.getElementById('final-comment-text');
            
            finalMenuItems.innerHTML = '';
            
            const menu = currentSuggestion.menu;
            let totalPrice = menu.price;
            
            // メインメニューを表示
            const menuItem = document.createElement('div');
            menuItem.className = 'menu-item';
            
            let spicyIndicator = '';
            if (menu.adjustedSpiciness && menu.adjustedSpiciness > 0) {
                const spicyLevel = menuDatabase.spicyLevels[menu.adjustedSpiciness];
                spicyIndicator = ` (辛さ${menu.adjustedSpiciness}: ${spicyLevel.name})`;
            }
            
            let signatureBadge = '';
            if (menu.isSignature) {
                signatureBadge = '<span class="signature-badge">名物</span>';
            }
            
            menuItem.innerHTML = `
                <div class="menu-name">🍜 ${menu.name}${spicyIndicator}${signatureBadge}</div>
                <div class="menu-price">${menu.price}円</div>
            `;
            finalMenuItems.appendChild(menuItem);
            
            // エクストラメニュー（サラダ）がある場合
            if (currentSuggestion.extraMenu) {
                const extraItem = document.createElement('div');
                extraItem.className = 'menu-item';
                extraItem.innerHTML = `
                    <div class="menu-name">🥗 ${currentSuggestion.extraMenu.name}</div>
                    <div class="menu-price">${currentSuggestion.extraMenu.price}円</div>
                `;
                finalMenuItems.appendChild(extraItem);
                totalPrice += currentSuggestion.extraMenu.price;
            }
            
            // 贅沢セットの複数エクストラメニューがある場合
            if (currentSuggestion.extraMenus) {
                currentSuggestion.extraMenus.forEach((extraMenu, index) => {
                    const extraItem = document.createElement('div');
                    extraItem.className = 'menu-item';
                    const icon = index === 0 ? '🥗' : '🍽️';
                    extraItem.innerHTML = `
                        <div class="menu-name">${icon} ${extraMenu.name}</div>
                        <div class="menu-price">${extraMenu.price}円</div>
                    `;
                    finalMenuItems.appendChild(extraItem);
                    totalPrice += extraMenu.price;
                });
            }
            
            // 合計金額を表示
            const totalItem = document.createElement('div');
            totalItem.className = 'menu-item';
            const finalPrice = currentSuggestion.totalPrice || totalPrice;
            totalItem.innerHTML = `
                <div class="menu-name">💰 合計金額</div>
                <div class="menu-price">${finalPrice}円</div>
            `;
            finalMenuItems.appendChild(totalItem);
            
            finalCommentText.textContent = `らんてんでの素敵なお食事をお楽しみください！${currentSuggestion.comment}`;
        }

        function finalDecision() {
            displayFinalDecision();
            showFinalScreen();
        }

        function showResultScreen() {
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';
            document.getElementById('final-screen').style.display = 'none';
        }

        function showFinalScreen() {
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('final-screen').style.display = 'block';
        }

        function goBack() {
            document.getElementById('selection-screen').style.display = 'block';
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('final-screen').style.display = 'none';
        }

        function restart() {
            // 選択状態をリセット
            selections = {budget: null, spiciness: null, allergies: [], mood: null};
            
            // ボタンの選択状態をリセット
            document.querySelectorAll('.choice-btn, .spicy-btn, .allergy-btn, .optional-btn, .no-allergy-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 提案ボタンを無効化
            document.getElementById('submit-btn').disabled = true;
            
            // 最初の画面を表示
            goBack();
        }

        // グローバル関数として公開
        window.adjustSpiciness = adjustSpiciness;
        window.finalDecision = finalDecision;
        window.goBack = goBack;
        window.restart = restart;
    </script>
</body>
</html>