<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MenuMate - ãƒ©ãƒ³ãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            padding: 30px 20px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px 20px;
        }

        .question {
            margin-bottom: 30px;
        }

        .question h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .required {
            color: #ff6b6b;
            font-size: 12px;
            font-weight: normal;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .choice-btn {
            flex: 1;
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .choice-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .optional-btn {
            width: 100%;
            padding: 15px;
            border: 2px dashed #e0e0e0;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .optional-btn:hover {
            background: #fff3cd;
            border-color: #feca57;
        }

        .optional-btn.selected {
            background: #feca57;
            color: white;
            border-color: #feca57;
        }

        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            display: none;
        }

        .result-card {
            background: #3db425;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .result-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .result-header h3 {
            color: #333;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .menu-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 18px;
            color: #000;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #667eea;
        }

        .menu-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .menu-price {
            font-weight: bold;
            color: #333;
        }

        .comment {
            background: #fff3cd;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #feca57;
        }

        .comment p {
            color: #333;
            font-size: 16px;
            line-height: 1.5;
        }

        .crowd-question {
            text-align: center;
            margin: 25px 0;
        }

        .crowd-question h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .crowd-buttons {
            display: flex;
            gap: 15px;
        }

        .crowd-btn {
            flex: 1;
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .crowd-btn.empty {
            border-color: #28a745;
            color: #28a745;
        }

        .crowd-btn.crowded {
            border-color: #dc3545;
            color: #dc3545;
        }

        .crowd-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .final-btn {
            width: 100%;
            padding: 18px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .final-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .back-btn {
            width: 100%;
            padding: 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .back-btn:hover {
            background: #545b62;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .choice-btn {
                min-width: 100%;
            }
        }

        /* Gacha Event Styles */
        .gacha-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .gacha-container {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .gacha-title {
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .gacha-machine {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 30px;
            background: linear-gradient(145deg, #ff4757, #ff3838);
            border-radius: 20px;
            border: 8px solid #ffffff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .gacha-ball {
            width: 120px;
            height: 120px;
            background: linear-gradient(145deg, #feca57, #ff9ff3);
            border-radius: 50%;
            border: 4px solid #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            animation: gachaSpin 2s linear infinite;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .gacha-ball.stopped {
            animation: gachaBounce 0.5s ease-out;
        }

        @keyframes gachaSpin {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        @keyframes gachaBounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0) scale(1);
            }
            40% {
                transform: translateY(-10px) scale(1.1);
            }
            60% {
                transform: translateY(-5px) scale(1.05);
            }
        }

        .gacha-sparkles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .sparkle {
            position: absolute;
            color: #feca57;
            font-size: 20px;
            animation: sparkle 1.5s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% {
                opacity: 0;
                transform: scale(0.5);
            }
            50% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .gacha-message {
            color: white;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gacha-character {
            font-size: 80px;
            margin: 20px 0;
            animation: characterAppear 0.8s ease-out;
        }

        @keyframes characterAppear {
            0% {
                opacity: 0;
                transform: scale(0.3) rotate(-10deg);
            }
            50% {
                transform: scale(1.2) rotate(5deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .excitement-text {
            color: #ff3838;
            font-size: 22px;
            font-weight: bold;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.3), 0 0 8px rgba(255,56,56,0.3);
            margin: 20px 0;
            animation: excitementPulse 1s ease-in-out infinite alternate;
        }

        @keyframes excitementPulse {
            0% {
                transform: scale(1);
                text-shadow: 2px 2px 6px rgba(0,0,0,0.3), 0 0 8px rgba(255,56,56,0.3);
            }
            100% {
                transform: scale(1.05);
                text-shadow: 2px 2px 8px rgba(0,0,0,0.4), 0 0 12px rgba(255,56,56,0.4);
            }
        }

        .gacha-machine.shaking {
            animation: machineShake 0.1s linear infinite;
        }

        @keyframes machineShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .special-glow {
            box-shadow: 0 0 20px rgba(254, 202, 87, 0.8), 
                        0 0 40px rgba(254, 202, 87, 0.6),
                        0 0 60px rgba(254, 202, 87, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ½ï¸ MenuMate</h1>
            <p>ä»Šæ—¥ã®ãƒ©ãƒ³ãƒã€ä¸€ç·’ã«æ±ºã‚ã¾ã—ã‚‡ã†ï¼</p>
        </div>

        <div id="selection-screen" class="content">
            <div class="question">
                <h3>ğŸ’° ä»Šæ—¥ã®ãŠè²¡å¸ƒäº‹æƒ…ã¯ï¼Ÿ <span class="required">â€»å¿…é ˆ</span></h3>
                <div class="button-group">
                    <button class="choice-btn" data-budget="rich">å¯Œè£•<br><small>450å††ä»¥ä¸Š</small></button>
                    <button class="choice-btn" data-budget="normal">æ™®é€š<br><small>400å††ç¨‹åº¦</small></button>
                    <button class="choice-btn" data-budget="poor">é‡‘æ¬ <br><small>300å††ä»¥ä¸‹</small></button>
                </div>
            </div>

            <div class="question">
                <h3>ğŸ½ï¸ ãŠè…¹ã®èª¿å­ã¯ï¼Ÿ <span class="required">â€»å¿…é ˆ</span></h3>
                <div class="button-group">
                    <button class="choice-btn" data-hunger="hungry">ã¯ã‚‰ãºã“<br><small>ãŒã£ã¤ã‚Šç³»</small></button>
                    <button class="choice-btn" data-hunger="light">å°‘é£Ÿ<br><small>è»½ã‚ç³»</small></button>
                </div>
            </div>

            <div class="question">
                <h3>âœ¨ ä»Šæ—¥ã®æ°—åˆ†ã¯ï¼Ÿ</h3>
                <button class="optional-btn" data-mood="special">ã‚¢ã‚²ã‚¢ã‚²<br><small>ç‰¹åˆ¥æ„Ÿã‚’æ±‚ã‚ã‚‹</small></button>
            </div>

            <button id="submit-btn" class="submit-btn" disabled>ğŸ¯ ææ¡ˆã—ã¦ï¼</button>
        </div>

        <div id="result-screen" class="content result">
            <div class="result-card">
                <div class="result-header">
                    <h3>ğŸ’¡ MenuMateã‹ã‚‰ã®ææ¡ˆ</h3>
                </div>
                <div id="menu-items"></div>
            </div>

            <div class="comment">
                <p id="comment-text"></p>
            </div>

            <div class="crowd-question">
                <h4>ã€æ··é›‘çŠ¶æ³ã¯ã©ã†ã§ã™ã‹ï¼Ÿã€‘</h4>
                <div class="crowd-buttons">
                    <button class="crowd-btn empty" onclick="handleCrowdStatus('empty')">
                        ğŸŸ¢ ç©ºã„ã¦ã‚‹<br><small>éººğŸœ</small>
                    </button>
                    <button class="crowd-btn crowded" onclick="handleCrowdStatus('crowded')">
                        ğŸ”´ æ··ã‚“ã§ã‚‹<br><small>å†ææ¡ˆ</small>
                    </button>
                </div>
            </div>

            <button class="final-btn" onclick="finalDecision()">âœ… ã“ã‚Œã«æ±ºã‚ãŸï¼</button>
            <button class="back-btn" onclick="goBack()">â† æœ€åˆã‹ã‚‰é¸ã³ç›´ã™</button>
        </div>

        <div id="final-screen" class="content result">
            <div class="result-header" style="text-align: center; margin-bottom: 30px;">
                <h3>ğŸ‰ æ±ºå®šã—ã¾ã—ãŸï¼</h3>
                <p style="margin-top: 10px; color: #666;">æœ€é«˜ã®ãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ ã‚’ãŠéã”ã—ãã ã•ã„</p>
                <div style="text-align: center; margin-top: 20px;">
                    <img src="GSYUASA.png" alt="GSYUASA Logo" style="max-width: 200px; height: auto;">
                </div>
            </div>
            
            <div class="result-card">
                <div class="result-header">
                    <h3>ğŸ“‹ é¸æŠã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
                </div>
                <div id="final-menu-items"></div>
            </div>

            <div class="comment">
                <p id="final-comment-text"></p>
            </div>
            
            <button class="back-btn" onclick="restart()">â† æ–°ã—ãé¸ã¶</button>
        </div>
    </div>

    <!-- Gacha Event Overlay -->
    <div id="gacha-overlay" class="gacha-overlay">
        <div class="gacha-container">
            <div class="gacha-title">âœ¨ ã‚¢ã‚²ã‚¢ã‚²<br>&nbsp;&nbsp;&nbsp;ã‚¬ãƒãƒ£ã‚¿ã‚¤ãƒ  âœ¨</div>
            
            <div class="gacha-machine">
                <div id="gacha-ball" class="gacha-ball">ğŸ°</div>
                <div class="gacha-sparkles">
                    <div class="sparkle" style="top: 10%; left: 20%;">âœ¨</div>
                    <div class="sparkle" style="top: 20%; right: 15%;">â­</div>
                    <div class="sparkle" style="bottom: 20%; left: 15%;">ğŸ’«</div>
                    <div class="sparkle" style="bottom: 10%; right: 20%;">âœ¨</div>
                </div>
            </div>
            
            <div id="gacha-message" class="gacha-message">ã‚¬ãƒãƒ£ã‚¬ãƒãƒ£å›è»¢ä¸­...</div>
            
            <div id="gacha-character" class="gacha-character" style="display: none;"></div>
            
            <div id="excitement-text" class="excitement-text" style="display: none;">
                ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼<br>å‡ºç¾ï¼ï¼
            </div>
        </div>
    </div>

    <script src="menuDatabase.js"></script>
    <script>

        // é¸æŠçŠ¶æ…‹
        let selections = {
            budget: null,
            hunger: null,
            mood: null
        };

        let currentSuggestion = null;
        let gachaEventTriggered = false;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            // é¸æŠãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.dataset.budget || this.dataset.hunger;
                    const category = this.dataset.budget ? 'budget' : 'hunger';
                    
                    // åŒã˜ã‚«ãƒ†ã‚´ãƒªã®ä»–ã®ãƒœã‚¿ãƒ³ã®é¸æŠã‚’è§£é™¤
                    document.querySelectorAll(`[data-${category}]`).forEach(b => b.classList.remove('selected'));
                    
                    this.classList.add('selected');
                    selections[category] = type;
                    
                    checkSubmitButton();
                });
            });

            // æ°—åˆ†ãƒœã‚¿ãƒ³ï¼ˆä»»æ„ï¼‰
            document.querySelector('.optional-btn').addEventListener('click', function() {
                this.classList.toggle('selected');
                selections.mood = this.classList.contains('selected') ? this.dataset.mood : null;
                
                // ã‚¢ã‚²ã‚¢ã‚²ãƒœã‚¿ãƒ³ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€ã‚¬ãƒãƒ£ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºå‹•ï¼ˆåˆå›ã®ã¿ï¼‰
                if (selections.mood === 'special' && !gachaEventTriggered) {
                    gachaEventTriggered = true;
                    triggerGachaEvent();
                }
            });

            // ææ¡ˆãƒœã‚¿ãƒ³
            document.getElementById('submit-btn').addEventListener('click', function() {
                generateSuggestion();
            });
        }

        function checkSubmitButton() {
            const submitBtn = document.getElementById('submit-btn');
            if (selections.budget && selections.hunger) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        function generateSuggestion(avoidCrowded = false, prioritizeRamen = false) {
            const suggestion = createSuggestion(selections, avoidCrowded, prioritizeRamen);
            currentSuggestion = suggestion;
            displaySuggestion(suggestion);
            showResultScreen();
        }

        function createSuggestion(selections, avoidCrowded = false, prioritizeRamen = false) {
            const budget = getBudgetRange(selections.budget);
            const isHungry = selections.hunger === 'hungry';
            const isSpecial = selections.mood === 'special';
            
            let availableItems = [...menuDatabase.main];
            
            // æ··é›‘å›é¿
            if (avoidCrowded) {
                availableItems = availableItems.filter(item => !item.crowded);
            }
            
            // ç©ºã„ã¦ã„ã‚‹å ´åˆã¯ãƒ©ãƒ¼ãƒ¡ãƒ³ã‚’å„ªå…ˆ
            if (prioritizeRamen) {
                const ramenItems = availableItems.filter(item => item.category === 'noodle');
                const otherItems = availableItems.filter(item => item.category !== 'noodle');
                availableItems = [...ramenItems, ...otherItems];
            }
            
            let suggestions = [];
            
            // äºˆç®—ã«å¿œã˜ãŸææ¡ˆç”Ÿæˆ
            for (let attempt = 0; attempt < 50; attempt++) {
                const suggestion = generateRandomCombination(availableItems, budget, isHungry, isSpecial, prioritizeRamen);
                if (suggestion && suggestion.total <= budget.max) {
                    suggestions.push(suggestion);
                    if (suggestions.length >= 2) break;
                }
            }
            
            // æœ€é©ãªææ¡ˆã‚’é¸æŠ
            if (suggestions.length > 0) {
                return suggestions[Math.floor(Math.random() * Math.min(suggestions.length, 2))];
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            return createFallbackSuggestion(budget);
        }

        function generateRandomCombination(availableItems, budget, isHungry, isSpecial, prioritizeRamen = false) {
            let items = [];
            let total = 0;
            
            // ç‰¹åˆ¥æ„Ÿã‚’æ±‚ã‚ã‚‹å ´åˆã¯ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼å„ªå…ˆ
            if (isSpecial) {
                availableItems = [...availableItems.filter(item => item.name.includes('ã‚¹ãƒšã‚·ãƒ£ãƒ«')), ...availableItems];
            }
            
            // ãƒ©ãƒ¼ãƒ¡ãƒ³å„ªå…ˆã®å ´åˆã¯éººé¡ã‚’æœ€å„ªå…ˆ
            if (prioritizeRamen) {
                availableItems = [...availableItems.filter(item => item.category === 'noodle'), ...availableItems];
            }
            
            // äºˆç®—ã¨é£Ÿæ¬²ã«åŸºã¥ãå“æ•°æ±ºå®š
            const budgetType = selections.budget;
            const hungerType = selections.hunger;
            let targetItemCount = 2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            
            if (budgetType === 'poor' && hungerType === 'light') {
                // é‡‘æ¬ ï¼‹å°‘é£Ÿï¼š290å††ä»¥å†…ã§2å“ç›®
                targetItemCount = 2;
                budget.max = Math.min(budget.max, 290);
            } else if (budgetType === 'normal' && hungerType === 'light') {
                // æ™®é€šï¼‹å°‘é£Ÿï¼š380å††ç¨‹åº¦ã§å‘³å™Œæ±ã‚’å«ã‚€3å“ç›®
                targetItemCount = 3;
                budget.max = Math.min(budget.max, 380);
            } else if (budgetType === 'normal' && hungerType === 'hungry') {
                // æ™®é€šï¼‹ã¯ã‚‰ãºã“ï¼š4å“ç›®
                targetItemCount = 4;
            } else if (budgetType === 'rich' && hungerType === 'hungry') {
                // å¯Œè£•ï¼‹ã¯ã‚‰ãºã“ï¼š5å“ç›®
                targetItemCount = 5;
            }
            
            // ã‚¢ã‚²ã‚¢ã‚²ã®å ´åˆã¯ãƒ‡ã‚¶ãƒ¼ãƒˆã‚’ãƒ—ãƒ©ã‚¹
            if (isSpecial) {
                targetItemCount += 1;
            }
            
            // ãƒ¡ã‚¤ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠ
            const mainItem = availableItems[Math.floor(Math.random() * Math.min(3, availableItems.length))];
            items.push(mainItem);
            total += mainItem.price;
            
            // çµ„ã¿åˆã‚ã›åˆ¶é™ãƒã‚§ãƒƒã‚¯
            const canAddRice = !['curry', 'bowl', 'bento'].includes(mainItem.category);
            
            // å“æ•°ã«å¿œã˜ã¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
            let attempts = 0;
            while (items.length < targetItemCount && attempts < 20) {
                attempts++;
                
                // å“æ•°ã«å¿œã˜ãŸå„ªå…ˆé †ä½
                if (items.length === 1 && canAddRice) {
                    // 2å“ç›®ï¼šã”é£¯ã‚’å„ªå…ˆ
                    const riceOptions = isHungry ? 
                        menuDatabase.rice.filter(r => r.name.includes('å¤§') || r.name.includes('ä¸­')) :
                        menuDatabase.rice.filter(r => !r.name.includes('å¤§'));
                    
                    if (riceOptions.length > 0) {
                        const rice = riceOptions[Math.floor(Math.random() * riceOptions.length)];
                        if (total + rice.price <= budget.max) {
                            items.push(rice);
                            total += rice.price;
                            continue;
                        }
                    }
                }
                
                if (items.length === 2 && (budgetType === 'normal' && hungerType === 'light')) {
                    // æ™®é€šï¼‹å°‘é£Ÿã®3å“ç›®ï¼šå‘³å™Œæ±ã‚’å¿…é ˆã§è¿½åŠ 
                    const misoSoup = menuDatabase.side.find(side => side.name === 'å‘³å™Œæ±');
                    if (misoSoup && total + misoSoup.price <= budget.max) {
                        items.push(misoSoup);
                        total += misoSoup.price;
                        continue;
                    }
                }
                
                // ã‚¢ã‚²ã‚¢ã‚²ã®å ´åˆã€æœ€å¾Œã«ãƒ‡ã‚¶ãƒ¼ãƒˆã‚’è¿½åŠ 
                if (isSpecial && items.length === targetItemCount - 1) {
                    const dessert = menuDatabase.side.find(side => side.category === 'dessert');
                    if (dessert && total + dessert.price <= budget.max) {
                        items.push(dessert);
                        total += dessert.price;
                        continue;
                    }
                }
                
                // ãã®ä»–ã®ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
                const affordableSides = menuDatabase.side.filter(side => 
                    total + side.price <= budget.max && 
                    !items.some(item => item.name === side.name)
                );
                
                if (affordableSides.length > 0) {
                    const side = affordableSides[Math.floor(Math.random() * affordableSides.length)];
                    items.push(side);
                    total += side.price;
                } else {
                    break; // äºˆç®—å†…ã§è¿½åŠ ã§ãã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„
                }
            }
            
            return {
                items: items,
                total: total,
                comment: generateComment(items, selections, total, prioritizeRamen)
            };
        }

        function getBudgetRange(budget) {
            switch(budget) {
                case 'rich': return {max: 500, min: 450};
                case 'normal': return {max: 450, min: 300};
                case 'poor': return {max: 300, min: 150};
                default: return {max: 400, min: 200};
            }
        }

        function generateComment(items, selections, total, prioritizeRamen = false) {
            const comments = [];
            
            // ãƒ©ãƒ¼ãƒ¡ãƒ³å„ªå…ˆæ™‚ã®ç‰¹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆ
            if (prioritizeRamen) {
                const hasRamen = items.some(item => item.category === 'noodle');
                if (hasRamen) {
                    comments.push('ä»ŠãŒãƒãƒ£ãƒ³ã‚¹ï¼ç†±ã€…éººé¡ã‚’æ¥½ã—ã‚ã¾ã™', 'ãƒ©ãƒƒã‚­ãƒ¼ï¼å¾…ã¡æ™‚é–“ãªã—ã§éººé¡ãŒé£Ÿã¹ã‚‰ã‚Œãã†', 'ç©ºã„ã¦ã‚‹ä»Šãªã‚‰éººé¡ãŒãŠã™ã™ã‚');
                }
            }
            
            if (selections.budget === 'poor') {
                comments.push('ç¯€ç´„ãƒ©ãƒ³ãƒã§ã‚‚ç¾å‘³ã—ãï¼', 'é‡‘æ¬ ã®å‘³æ–¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã™', 'ã‚³ã‚¹ãƒ‘æœ€é«˜ã®çµ„ã¿åˆã‚ã›');
            } else if (selections.budget === 'rich') {
                comments.push('ä»Šæ—¥ã¯ã¡ã‚‡ã£ã¨è´…æ²¢ã—ã¾ã—ã‚‡ã†ï¼', 'å……å®Ÿãƒ©ãƒ³ãƒã§åˆå¾Œã‚‚é ‘å¼µã£ã¦', 'ãƒªãƒƒãƒãªãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ ');
            } else {
                comments.push('ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„çµ„ã¿åˆã‚ã›ã§ã™', 'å®šç•ªã§é–“é•ã„ãªã—', 'æ™®é€šäºˆç®—ã§ã—ã£ã‹ã‚Šã¨');
            }
            
            if (selections.hunger === 'hungry') {
                comments.push('ãŒã£ã¤ã‚Šé£Ÿã¹ã¦å…ƒæ°—ãƒãƒ£ãƒ¼ã‚¸ï¼', 'ãƒœãƒªãƒ¥ãƒ¼ãƒ æº€ç‚¹ã§æº€è¶³åº¦â—');
            } else {
                comments.push('è»½ã‚„ã‹ãƒ©ãƒ³ãƒã§åˆå¾Œã‚‚ã™ã£ãã‚Š', 'ãƒ˜ãƒ«ã‚·ãƒ¼ã§ä½“ã«å„ªã—ã„');
            }
            
            if (selections.mood === 'special') {
                comments.push('ä»Šæ—¥ã¯ç‰¹åˆ¥ãªæ—¥ã§ã™ã­ï¼', 'ã‚¹ãƒšã‚·ãƒ£ãƒ«æ°—åˆ†ã«ã´ã£ãŸã‚Š');
            }
            
            return comments[Math.floor(Math.random() * comments.length)];
        }

        function createFallbackSuggestion(budget) {
            if (budget.max <= 300) {
                return {
                    items: [{name: 'ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹', price: 200, icon: 'ğŸ›'}],
                    total: 200,
                    comment: 'å®šç•ªã‚«ãƒ¬ãƒ¼ã§é–“é•ã„ãªã—ï¼'
                };
            } else {
                return {
                    items: [
                        {name: 'ãŠé­šãƒ—ãƒ¬ãƒ¼ãƒˆ', price: 200, icon: 'ğŸŸ'},
                        {name: 'ã”é£¯ï¼ˆä¸­ï¼‰', price: 90, icon: 'ğŸš'},
                        {name: 'å‘³å™Œæ±', price: 60, icon: 'ğŸ²'}
                    ],
                    total: 350,
                    comment: 'ãƒãƒ©ãƒ³ã‚¹è‰¯ã„å®šé£Ÿã‚¹ã‚¿ã‚¤ãƒ«ï¼'
                };
            }
        }

        function displaySuggestion(suggestion) {
            const menuItems = document.getElementById('menu-items');
            const commentText = document.getElementById('comment-text');
            
            menuItems.innerHTML = '';
            
            suggestion.items.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.innerHTML = `
                    <div class="menu-name">${item.icon} ${item.name}</div>
                    <div class="menu-price">${item.price}å††</div>
                `;
                menuItems.appendChild(menuItem);
            });
            
            // åˆè¨ˆã‚’è¿½åŠ 
            const totalItem = document.createElement('div');
            totalItem.className = 'menu-item';
            totalItem.innerHTML = `
                <div class="menu-name">ğŸ’° åˆè¨ˆé‡‘é¡</div>
                <div class="menu-price">${suggestion.total}å††</div>
            `;
            menuItems.appendChild(totalItem);
            
            commentText.textContent = `ğŸ’¬ ${suggestion.comment}`;
        }

        function displayFinalDecision() {
            if (!currentSuggestion) return;
            
            const finalMenuItems = document.getElementById('final-menu-items');
            const finalCommentText = document.getElementById('final-comment-text');
            
            finalMenuItems.innerHTML = '';
            
            currentSuggestion.items.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.innerHTML = `
                    <div class="menu-name">${item.icon} ${item.name}</div>
                    <div class="menu-price">${item.price}å††</div>
                `;
                finalMenuItems.appendChild(menuItem);
            });
            
            // åˆè¨ˆã‚’è¿½åŠ 
            const totalItem = document.createElement('div');
            totalItem.className = 'menu-item';
            totalItem.innerHTML = `
                <div class="menu-name">ğŸ’° åˆè¨ˆé‡‘é¡</div>
                <div class="menu-price">${currentSuggestion.total}å††</div>
            `;
            finalMenuItems.appendChild(totalItem);
            
            finalCommentText.textContent = `ğŸ’¬ ${currentSuggestion.comment}`;
        }

        function handleCrowdStatus(status) {
            if (status === 'crowded') {
                generateSuggestion(true); // æ··é›‘ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¿ã‘ã¦å†ææ¡ˆ
            } else {
                generateSuggestion(false, true); // ç©ºã„ã¦ã„ã‚‹å ´åˆã¯ãƒ©ãƒ¼ãƒ¡ãƒ³ã‚’å„ªå…ˆã—ã¦å†ææ¡ˆ
            }
        }

        function finalDecision() {
            displayFinalDecision();
            showFinalScreen();
        }

        function showResultScreen() {
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';
            document.getElementById('final-screen').style.display = 'none';
        }

        function showFinalScreen() {
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('final-screen').style.display = 'block';
        }

        function goBack() {
            document.getElementById('selection-screen').style.display = 'block';
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('final-screen').style.display = 'none';
        }

        function restart() {
            // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            selections = {budget: null, hunger: null, mood: null};
            
            // ã‚¬ãƒãƒ£ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
            gachaEventTriggered = false;
            
            // ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.choice-btn, .optional-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // ææ¡ˆãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            document.getElementById('submit-btn').disabled = true;
            
            // æœ€åˆã®ç”»é¢ã‚’è¡¨ç¤º
            goBack();
        }

        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ãŸéŸ³éŸ¿åŠ¹æœ
        function createAudioController() {
            let drumrollAudio = null;
            let finishAudio = null;
            
            try {
                drumrollAudio = new Audio('ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«.mp3');
                finishAudio = new Audio('æ±ºå®šãƒœã‚¿ãƒ³ã‚’æŠ¼ã™37 (1).mp3');
                
                // éŸ³å£°ã®è¨­å®š
                drumrollAudio.loop = true;
                drumrollAudio.volume = 0.7;
                finishAudio.volume = 0.8;
                
                // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
                drumrollAudio.preload = 'auto';
                finishAudio.preload = 'auto';
                
            } catch (error) {
                console.log('Audio files not found:', error);
            }
            
            return {
                start: () => {
                    if (drumrollAudio) {
                        drumrollAudio.currentTime = 0;
                        drumrollAudio.play().catch(e => console.log('Drumroll play failed:', e));
                    }
                },
                stop: () => {
                    if (drumrollAudio) {
                        drumrollAudio.pause();
                        drumrollAudio.currentTime = 0;
                    }
                },
                playFinishSound: () => {
                    if (finishAudio) {
                        finishAudio.currentTime = 0;
                        finishAudio.play().catch(e => console.log('Finish sound play failed:', e));
                    }
                }
            };
        }

        // ã‚¬ãƒãƒ£ã‚¤ãƒ™ãƒ³ãƒˆé–¢é€£ã®é–¢æ•°
        function triggerGachaEvent() {
            const overlay = document.getElementById('gacha-overlay');
            const ball = document.getElementById('gacha-ball');
            const machine = document.querySelector('.gacha-machine');
            const message = document.getElementById('gacha-message');
            const character = document.getElementById('gacha-character');
            const excitementText = document.getElementById('excitement-text');
            
            // éŸ³å£°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä½œæˆ
            const audioController = createAudioController();
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
            overlay.style.display = 'flex';
            
            // åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
            ball.classList.remove('stopped');
            machine.classList.remove('shaking', 'special-glow');
            character.style.display = 'none';
            excitementText.style.display = 'none';
            message.textContent = 'ã‚¬ãƒãƒ£ã‚¬ãƒãƒ£å›è»¢ä¸­...';
            ball.textContent = 'ğŸ°';
            
            // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100, 50, 200]);
            }
            
            // ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«é–‹å§‹
            audioController.start();
            
            // ãƒã‚·ãƒ³ã«ã‚·ã‚§ã‚¤ã‚¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
            machine.classList.add('shaking');
            
            // ã‚¹ãƒ”ãƒ³æ™‚é–“ã‚’4ç§’ã«å¤‰æ›´
            const spinDuration = 4000; // 4ç§’
            
            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰é£Ÿå ‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®çµµæ–‡å­—ã‚’å–å¾—
            const menuItems = [];
            // ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰çµµæ–‡å­—ã‚’å–å¾—
            menuDatabase.main.forEach(item => menuItems.push(item.icon));
            // ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰çµµæ–‡å­—ã‚’å–å¾—
            menuDatabase.side.forEach(item => menuItems.push(item.icon));
            // ã”é£¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰çµµæ–‡å­—ã‚’å–å¾—
            menuDatabase.rice.forEach(item => menuItems.push(item.icon));
            
            // é‡è¤‡ã‚’é™¤å»
            const foodEmojis = [...new Set(menuItems)];
            
            // ãƒ©ãƒ³ãƒ€ãƒ ã«é£Ÿå ‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å¤‰æ›´ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const charChangeInterval = setInterval(() => {
                ball.textContent = foodEmojis[Math.floor(Math.random() * foodEmojis.length)];
            }, 120); // å°‘ã—é€Ÿã‚ã«åˆ‡ã‚Šæ›¿ãˆ
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const messages = [
                'ä»Šæ—¥ã®ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ï¼Ÿ',
                'ã‚¬ãƒãƒ£ã‚¬ãƒãƒ£å›è»¢ä¸­...',
                'ä½•ãŒå‡ºã‚‹ã‹ãªï¼Ÿ',
                'ãƒ¯ã‚¯ãƒ¯ã‚¯ãƒ‰ã‚­ãƒ‰ã‚­ï¼',
                'ã‚‚ã†ã™ãæ±ºã¾ã‚‹ã‚ˆ...',
                'ã‚¢ã‚²ã‚¢ã‚²ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»å ´äºˆæ„Ÿï¼'
            ];
            let messageIndex = 0;
            const messageInterval = setInterval(() => {
                message.textContent = messages[messageIndex % messages.length];
                messageIndex++;
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªçŸ­ã„ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                if (navigator.vibrate && Math.random() < 0.2) {
                    navigator.vibrate(30);
                }
            }, 800);
            
            // 4ç§’å¾Œã«åœæ­¢ã—ã¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤º
            setTimeout(() => {
                clearInterval(charChangeInterval);
                clearInterval(messageInterval);
                
                // ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«åœæ­¢ã¨ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥éŸ³
                audioController.stop();
                audioController.playFinishSound();
                
                // ã‚·ã‚§ã‚¤ã‚¯ã‚’åœæ­¢
                machine.classList.remove('shaking');
                
                // ãƒœãƒ¼ãƒ«ã‚’åœæ­¢çŠ¶æ…‹ã«
                ball.classList.add('stopped');
                
                // æœ€çµ‚çš„ãªé£Ÿå ‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠï¼ˆã‚¹ãƒšã‚·ãƒ£ãƒ«ç³»ã‚’å„ªå…ˆï¼‰
                const specialItems = menuDatabase.main.filter(item => item.name.includes('ã‚¹ãƒšã‚·ãƒ£ãƒ«'));
                const finalEmoji = specialItems.length > 0 && Math.random() < 0.4 
                    ? specialItems[Math.floor(Math.random() * specialItems.length)].icon
                    : foodEmojis[Math.floor(Math.random() * foodEmojis.length)];
                    
                ball.textContent = finalEmoji;
                
                // ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                machine.classList.add('special-glow');
                
                // æˆåŠŸãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200, 100, 300]);
                }
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
                message.textContent = 'ã‚¢ã‚²ã‚¢ã‚²æˆåŠŸï¼';
                
                // å¤§ããªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¡¨ç¤º
                setTimeout(() => {
                    character.textContent = finalEmoji;
                    character.style.display = 'block';
                    excitementText.style.display = 'block';
                }, 500);
                
                // 3ç§’å¾Œã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‰ã˜ã¦ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆã‚’è¡¨ç¤º
                setTimeout(() => {
                    closeGachaEvent();
                    // ã‚¬ãƒãƒ£ã‚¤ãƒ™ãƒ³ãƒˆå¾Œã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆã‚’è‡ªå‹•å®Ÿè¡Œ
                    if (selections.budget && selections.hunger) {
                        generateSuggestion();
                    }
                }, 3000);
                
            }, spinDuration);
        }
        
        function closeGachaEvent() {
            const overlay = document.getElementById('gacha-overlay');
            overlay.style.display = 'none';
        }

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚é–‰ã˜ã‚‹
        document.getElementById('gacha-overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeGachaEvent();
            }
        });
    </script>
</body>
</html>